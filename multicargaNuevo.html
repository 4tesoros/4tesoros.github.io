<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario de Reservas de Oficinas</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #007BFF; color: white; }
    .libre { background-color: #d4edda; cursor: pointer; }
    .ocupado { background-color: #f8d7da; cursor: pointer; }
    #resumen { margin-top: 20px; background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    #recurrente-form { background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 5px; margin-top: 30px; }
    label { display: block; margin-top: 10px; }
    input, select { padding: 5px; width: 100%; max-width: 300px; }
    button { margin-top: 15px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>Calendario solo Administradores</h1>
  
  <label for="fecha">Seleccionar fecha: </label>
  <input type="date" id="fecha">
  
  <table id="calendario">
    <tr>
      <th>Hora</th>
      <th>Recepcion</th>
      <th>Ofi 1 (med)</th>
      <th>Ofi 2(1°piso)</th>
      <th>Ofi 3 (gde)</th>
    </tr>
  </table>
  
  <div id="resumen">
    <h3>Resumen de Reservas</h3>
    <p id="totalReservas">Total de reservas activas: 0</p>
  </div>

  <div id="recurrente-form">
    <h3>Reservas Recurrentes</h3>
    <label for="nombre">Nombre del cliente:</label>
    <input type="text" id="nombre">

    <label for="oficina">Oficina (1 a 4):</label>
    <select id="oficina">
      <option value="oficina1">Recepcion</option>
      <option value="oficina2">Ofi 1 (med)</option>
      <option value="oficina3">Ofi 2 (1°piso)</option>
      <option value="oficina4">Ofi 3 (gde)</option>
    </select>

    <label for="diaSemana">Día de la semana:</label>
    <select id="diaSemana">
      <option value="0">Lunes</option>
      <option value="1">Martes</option>
      <option value="2">Miércoles</option>
      <option value="3">Jueves</option>
      <option value="4">Viernes</option>
      <option value="5">Sábado</option>
      <option value="6">Domingo</option>
    </select>

    <label for="desde">Hora desde (ej: 16:00):</label>
    <input type="time" id="desde">

    <label for="hasta">Hora hasta (ej: 20:00):</label>
    <input type="time" id="hasta">

    <label for="inicio">Fecha de inicio:</label>
    <input type="date" id="inicio">

    <label for="fin">Fecha de fin:</label>
    <input type="date" id="fin">

    <button id="crearRecurrentes">Crear Reservas</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoTNjnjkkgUBDaVI2To5ScA83_q6ZMy-s",
      authDomain: "gamers-a1763.firebaseapp.com",
      projectId: "gamers-a1763",
      storageBucket: "gamers-a1763.appspot.com",
      messagingSenderId: "279036766390",
      appId: "1:279036766390:web:e67ce235630f444d0f5e17"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const horarios = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00"];
    const calendario = document.getElementById('calendario');
    const fechaInput = document.getElementById('fecha');
    const totalReservas = document.getElementById('totalReservas');

    function actualizarCalendario() {
      calendario.innerHTML = `<tr><th>Hora</th><th>Recepcion</th><th>Ofi 1 (med)</th><th>Ofi 2(1°piso)</th><th>Ofi 3 (gde)</th></tr>`;
      horarios.forEach(hora => {
        const fila = document.createElement('tr');
        fila.innerHTML = `<td>${hora}</td>`;
        for (let i = 1; i <= 4; i++) {
          const celda = document.createElement('td');
          celda.className = 'libre';
          celda.textContent = 'Libre';
          celda.dataset.hora = hora;
          celda.dataset.oficina = `oficina${i}`;
          fila.appendChild(celda);
        }
        calendario.appendChild(fila);
      });
      escucharReservas();
    }

    async function gestionarReserva(event) {
      const celda = event.target;
      if (!celda.dataset.hora) return;

      const fecha = fechaInput.value;
      const hora = celda.dataset.hora;
      const oficina = celda.dataset.oficina;

      if (celda.classList.contains('libre')) {
        const cliente = prompt('Ingrese el nombre del cliente:');
        if (cliente) {
          try {
            await addDoc(collection(db, "reservas"), { fecha, hora, oficina, cliente });
          } catch (error) {
            alert("Error al reservar: " + error.message);
          }
        }
      } else {
        if (confirm('¿Desea liberar esta reserva?')) {
          const reservaId = celda.dataset.id;
          if (reservaId) {
            try {
              await deleteDoc(doc(db, "reservas", reservaId));
            } catch (error) {
              alert("Error al eliminar la reserva: " + error.message);
            }
          }
        }
      }
    }

    function escucharReservas() {
      if (!fechaInput.value) return;
      const reservasQuery = query(collection(db, "reservas"), where("fecha", "==", fechaInput.value));
      onSnapshot(reservasQuery, (snapshot) => {
        const reservas = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.hora}-${data.oficina}`;
          reservas[key] = { cliente: data.cliente, id: doc.id };
        });

        document.querySelectorAll('td.libre, td.ocupado').forEach(celda => {
          const key = `${celda.dataset.hora}-${celda.dataset.oficina}`;
          if (reservas[key]) {
            celda.className = 'ocupado';
            celda.textContent = `${reservas[key].cliente}`;
            celda.dataset.id = reservas[key].id;
          } else {
            celda.className = 'libre';
            celda.textContent = 'Libre';
            delete celda.dataset.id;
          }
        });
        totalReservas.textContent = `Total de reservas activas: ${snapshot.size}`;
      });
    }

    async function crearReservasRecurrentes() {
      const nombre = document.getElementById("nombre").value.trim();
      const oficina = document.getElementById("oficina").value;
      const diaSemana = parseInt(document.getElementById("diaSemana").value);
      const desde = document.getElementById("desde").value;
      const hasta = document.getElementById("hasta").value;
      const inicio = new Date(document.getElementById("inicio").value);
      const fin = new Date(document.getElementById("fin").value);

      if (!nombre || !desde || !hasta || isNaN(inicio) || isNaN(fin)) {
        alert("Complete todos los campos correctamente.");
        return;
      }

      const horasSeleccionadas = horarios.filter(h => h >= desde && h <= hasta);
      let fechaActual = new Date(inicio);

      while (fechaActual <= fin) {
        if (fechaActual.getDay() === diaSemana) {
          const fechaStr = fechaActual.toISOString().split("T")[0];
          for (const hora of horasSeleccionadas) {
            try {
              await addDoc(collection(db, "reservas"), {
                fecha: fechaStr,
                hora,
                oficina,
                cliente: nombre
              });
            } catch (e) {
              console.error("Error al crear reserva:", e);
            }
          }
        }
        fechaActual.setDate(fechaActual.getDate() + 1);
      }

      alert("Reservas recurrentes creadas.");
    }

    document.getElementById("crearRecurrentes").addEventListener("click", crearReservasRecurrentes);
    fechaInput.addEventListener('change', actualizarCalendario);
    calendario.addEventListener('click', gestionarReserva);
    actualizarCalendario();
  </script>
</body>
</html>